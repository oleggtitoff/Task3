#include <stdio.h>
#include <stdint.h>
#include <math.h>
#include <stdlib.h>

#define INPUT_FILE_NAME "Input.wav"
#define OUTPUT_FILE_NAME "Output.wav"
#define FILE_HEADER_SIZE 44
#define BYTES_PER_SAMPLE 2
#define FRACTIONAL_BITS 31
#define COEFFICIENTS_SIZE 128


typedef struct {
	int8_t currNum;
	int32_t *samples[COEFFICIENTS_SIZE];
} RingBuff;


int32_t doubleToFixed32(double x);
int32_t Add(int32_t x, int32_t y);
int32_t Mul(int32_t x, int32_t y);
int32_t Mac(int32_t x, int32_t y, int32_t acc);

void coefsDoubleToFixed32(double *input, int32_t *output);
void ringInitialization(RingBuff *buff);

void readHeader(uint8_t *headerBuff, FILE *inputFilePtr);
void writeHeader(uint8_t *headerBuff, FILE *outputFilePtr);
uint32_t defineDataSize(uint8_t *headerBuff);
int16_t readSample(FILE *inputFilePtr);
void writeSample(FILE *outputFilePtr, int16_t sample);

FILE * openFile(char *fileName, _Bool mode);	//if 0 - read, if 1 - write
void closeFile(FILE *filePtr);

int32_t firFilter(RingBuff *ringBuff, int32_t *coefsBuff);
void processData(FILE *inputFilePtr, FILE *outputFilePtr, uint32_t dataSize, RingBuff *ringBuff, int32_t *coefsBuff);


int main()
{
	FILE *inputFilePtr = openFile(INPUT_FILE_NAME, 0);
	FILE *outputFilePtr = openFile(OUTPUT_FILE_NAME, 1);
	uint8_t headerBuff[FILE_HEADER_SIZE];
	double coefsDoubleBuff[COEFFICIENTS_SIZE] = {
		-0.000162164358122296535080070212231362348,
		0.001871990160621829881251731997338083602,
		0.000177421074278205637142491468694061041,
		-0.000799938339957202400667957142843533802,
		0.000029445930738341338089858467697013111,
		0.000975875559570133681644432677160239109,
		-0.000174332633474075845286810348966355377,
		-0.001142739689442697631482914744083245751,
		0.000370491577463436688212594649627362742,
		0.001301881690598231770816806118773456546,
		-0.000622077986506033506208801497905369615,
		-0.001441449932844418493210758569489371439,
		0.000932402583730824563272576721573159375,
		0.001550174587877081733289230669470271096,
		-0.001302822619389340953049982729794464831,
		-0.001613386681590385333950887769560722518,
		0.001732469863172050698885140462834897335,
		0.001616617300957494916813228513774447492,
		-0.00221862576667492894869071484720279841,
		-0.001543657072345475025215710829229465162,
		0.002754940419298467901149107817104777496,
		0.001378463028443757676377856569160940126,
		-0.003333276559124515384113784932651469717,
		-0.001103707153510167897347837850929863635,
		0.003941689681336679740297768148593604565,
		0.000703262526727135503512577940909977769,
		-0.004565291704341306600056782372121233493,
		-0.000160412088138313022045444711238815216,
		0.005184773540519031602424870897038999829,
		-0.000539621548383245391508622468279554596,
		-0.005778912866566685360703026219653111184,
		0.001411823120786187893416219196751626441,
		0.006322138141064522626200172794597165193,
		-0.00246974610702698545855460210418641509,
		-0.006786253611573941565970891076631232863,
		0.003728315587545509915412544899027125211,
		0.00713721779746414979050950222472238238,
		-0.005200340179343024282765384214144432917,
		-0.007338326806005588710812848063369528973,
		0.006901001742960421840578089103246384184,
		0.007346158056545955619687227056147094117,
		-0.00884755574351601785376697506535492721,
		-0.007111774028954947340919190423846885096,
		0.011067298609159212374741798612376442179,
		0.006570507333481337766678542777754046256,
		-0.013595462859419383747083820423995348392,
		-0.005644429523601306696034551890761576942,
		0.016492964039346743460034971917593793478,
		0.004223704726346500307188058798146812478,
		-0.019858876451125911932749090738070663065,
		-0.002145249494208243887238829472607903881,
		0.02386518959950843093986705412135052029,
		-0.000856104435109718980845272540136647876,
		-0.028832854859967373128970535844928235747,
		0.005258383178987129091819241466509993188,
		0.035404998106579571581775667254987638444,
		-0.012038069712799946003878304168210888747,
		-0.045046331468904660111363114083360414952,
		0.023589425202695950972708871518079831731,
		0.06186864353234792363034344475636316929,
		-0.047784444108668819306551256431703222916,
		-0.103231863934425432960395596637681592256,
		0.134497338921223313912278740644978825003,
		0.464599278002360449590923963114619255066,
		0.464599278002360449590923963114619255066,
		0.134497338921223313912278740644978825003,
		-0.103231863934425432960395596637681592256,
		-0.047784444108668819306551256431703222916,
		0.06186864353234792363034344475636316929,
		0.023589425202695950972708871518079831731,
		-0.045046331468904660111363114083360414952,
		-0.012038069712799946003878304168210888747,
		0.035404998106579571581775667254987638444,
		0.005258383178987129091819241466509993188,
		-0.028832854859967373128970535844928235747,
		-0.000856104435109718980845272540136647876,
		0.02386518959950843093986705412135052029,
		-0.002145249494208243887238829472607903881,
		-0.019858876451125911932749090738070663065,
		0.004223704726346500307188058798146812478,
		0.016492964039346743460034971917593793478,
		-0.005644429523601306696034551890761576942,
		-0.013595462859419383747083820423995348392,
		0.006570507333481337766678542777754046256,
		0.011067298609159212374741798612376442179,
		-0.007111774028954947340919190423846885096,
		-0.00884755574351601785376697506535492721,
		0.007346158056545955619687227056147094117,
		0.006901001742960421840578089103246384184,
		-0.007338326806005588710812848063369528973,
		-0.005200340179343024282765384214144432917,
		0.00713721779746414979050950222472238238,
		0.003728315587545509915412544899027125211,
		-0.006786253611573941565970891076631232863,
		-0.00246974610702698545855460210418641509,
		0.006322138141064522626200172794597165193,
		0.001411823120786187893416219196751626441,
		-0.005778912866566685360703026219653111184,
		-0.000539621548383245391508622468279554596,
		0.005184773540519031602424870897038999829,
		-0.000160412088138313022045444711238815216,
		-0.004565291704341306600056782372121233493,
		0.000703262526727135503512577940909977769,
		0.003941689681336679740297768148593604565,
		-0.001103707153510167897347837850929863635,
		-0.003333276559124515384113784932651469717,
		0.001378463028443757676377856569160940126,
		0.002754940419298467901149107817104777496,
		-0.001543657072345475025215710829229465162,
		-0.00221862576667492894869071484720279841,
		0.001616617300957494916813228513774447492,
		0.001732469863172050698885140462834897335,
		-0.001613386681590385333950887769560722518,
		-0.001302822619389340953049982729794464831,
		0.001550174587877081733289230669470271096,
		0.000932402583730824563272576721573159375,
		-0.001441449932844418493210758569489371439,
		-0.000622077986506033506208801497905369615,
		0.001301881690598231770816806118773456546,
		0.000370491577463436688212594649627362742,
		-0.001142739689442697631482914744083245751,
		-0.000174332633474075845286810348966355377,
		0.000975875559570133681644432677160239109,
		0.000029445930738341338089858467697013111,
		-0.000799938339957202400667957142843533802,
		0.000177421074278205637142491468694061041,
		0.001871990160621829881251731997338083602,
		-0.000162164358122296535080070212231362348
	};
	int32_t coefsBuff[COEFFICIENTS_SIZE];
	RingBuff samplesBuff;

	coefsDoubleToFixed32(coefsDoubleBuff, coefsBuff);
	ringInitialization(&samplesBuff);

	readHeader(headerBuff, inputFilePtr);
	writeHeader(headerBuff, outputFilePtr);
	processData(inputFilePtr, outputFilePtr, defineDataSize(headerBuff), &samplesBuff, &coefsBuff);
	closeFile(inputFilePtr);
	closeFile(outputFilePtr);

	system("pause");
	return 0;
}

int32_t doubleToFixed32(double x)
{
	if (x >= 1)
	{
		return INT32_MAX;
	}
	else if (x < -1)
	{
		return INT32_MIN;
	}

	return (int32_t)(x * (double)(1LL << FRACTIONAL_BITS));
}

int32_t	Saturation(int64_t x)
{
	if (x < (int64_t)INT32_MIN)
	{
		return INT32_MIN;
	}
	else if (x >(int64_t)INT32_MAX)
	{
		return INT32_MAX;
	}

	return (int32_t)x;
}

int32_t roundFixed64To32(int64_t x)
{
	return (int32_t)((x + (1LL << 31) >> 32));
}

int32_t Add(int32_t x, int32_t y)
{
	return Saturation((int64_t)x + y);
}

int32_t Mul(int32_t x, int32_t y)
{
	if (x == INT32_MIN && y == INT32_MIN)
	{
		return INT32_MAX;
	}

	return roundFixed64To32(((int64_t)x * y) << 1);
}

int32_t Mac(int32_t x, int32_t y, int32_t acc)
{
	return Add(Mul(x, y), acc);
}

void coefsDoubleToFixed32(double *input, int32_t *output)
{
	int i;

	for (i = 0; i < COEFFICIENTS_SIZE; i++)
	{
		*(output + i) = doubleToFixed32(*(input + i));
	}
}

void ringInitialization(RingBuff *buff)
{
	int i;

	for (i = 0; i < COEFFICIENTS_SIZE; i++)
	{
		*(buff->samples + i) = 0;
	}

	buff->currNum = 0;
}

void readHeader(uint8_t *headerBuff, FILE *inputFilePtr)
{
	if (fread(headerBuff, FILE_HEADER_SIZE, 1, inputFilePtr) != 1)
	{
		printf("Error reading input file (header)\n");
		system("pause");
		exit(0);
	}
}

void writeHeader(uint8_t *headerBuff, FILE *outputFilePtr)
{
	if (fwrite(headerBuff, FILE_HEADER_SIZE, 1, outputFilePtr) != 1)
	{
		printf("Error writing output file (header)\n");
		system("pause");
		exit(0);
	}
}

uint32_t defineDataSize(uint8_t *headerBuff)
{
	return (*(headerBuff + FILE_HEADER_SIZE - 4)) |
		(*(headerBuff + FILE_HEADER_SIZE - 3) << 8) |
		(*(headerBuff + FILE_HEADER_SIZE - 2) << 16) |
		(*(headerBuff + FILE_HEADER_SIZE - 1) << 24);
}

int16_t readSample(FILE *inputFilePtr)
{
	int16_t buff;

	if (fread(&buff, BYTES_PER_SAMPLE, 1, inputFilePtr) != 1)
	{
		printf("Error reading input file (data)\n");
		system("pause");
		exit(0);
	}

	return buff;
}

void writeSample(FILE *outputFilePtr, int16_t sample)
{
	if (fwrite(&sample, BYTES_PER_SAMPLE, 1, outputFilePtr) != 1)
	{
		printf("Error writing output file (data)\n");
		system("pause");
		exit(0);
	}
}

FILE *openFile(char *fileName, _Bool mode)		//if 0 - read, if 1 - write
{
	FILE * filePtr = NULL;
	errno_t err;

	if (mode == 0)
	{
		err = fopen_s(&filePtr, fileName, "rb");
	}
	else
	{
		err = fopen_s(&filePtr, fileName, "wb");
	}

	if (err != 0)
	{
		if (mode == 0)
		{
			printf("Error opening input file\n");
		}
		else
		{
			printf("Error opening output file\n");
		}

		system("pause");
		exit(0);
	}

	return filePtr;
}

void closeFile(FILE *filePtr)
{
	fclose(filePtr);
}

int32_t firFilter(RingBuff *ringBuff, int32_t *coefsBuff)
{
	int16_t i;
	int32_t accum = 0;

	for (i = 0; i < COEFFICIENTS_SIZE; i++)
	{
		accum = Mac(*(ringBuff->samples + ((ringBuff->currNum - i) & (COEFFICIENTS_SIZE - 1))),
			*(coefsBuff + i), accum);
	}

	ringBuff->currNum = (ringBuff->currNum++) & (COEFFICIENTS_SIZE - 1);
	return accum;
}

void processData(FILE *inputFilePtr, FILE *outputFilePtr, uint32_t dataSize, RingBuff *ringBuff, int32_t *coefsBuff)
{
	uint32_t i;

	for (i = 0; i < dataSize / BYTES_PER_SAMPLE; i++)
	{
		int32_t sample = (int32_t)readSample(inputFilePtr) << 16;
		*(ringBuff->samples + ringBuff->currNum) = sample;
		sample = firFilter(ringBuff, coefsBuff);
		writeSample(outputFilePtr, (int16_t)(sample >> 16)); //TODO: round sample
	}
}